{% extends model('component') %}

{% define config = {
    name: 'product-configurator',
    tag: 'section'
} %}

{% define data = {
    product: required,
    maxQuantity: 10
} %}

{% set options = [] %}
{% set brand = data.product.attributes.brand | default %}
{% set sku = data.product.sku %}
{% set availabilityWidget = '' %}
{% set isDisabled = data.product.idProductConcrete is empty or data.product.price is empty %}
{% set isProductAvailable = true %}

{% for index in 1..data.maxQuantity %}
    {% set options = options | merge([{
        label: index,
        value: index
    }]) %}
{% endfor %}

{% set productViewAvailabilityWidget = findWidget('ProductViewAvailabilityWidget', [data.product]) %}
{% set isAvailable = productViewAvailabilityWidget.isAvailable | default(widgetBlock('AvailabilityWidgetPlugin', 'isAvailable', data.product)) %} {# @deprecated Use ProductViewAvailabilityWidget instead of AvailabilityWidgetPlugin. #}
{% set isDisabled = not isAvailable or isDisabled %}

{% set productDiscontinuedNoteWidget = findWidget('ProductDiscontinuedNoteWidget', [sku]) %}
{% set isDiscontinued = productDiscontinuedNoteWidget.isDiscontinued | default(widgetBlock('ProductDiscontinuedWidgetPlugin', 'isDiscontinued', sku)) %} {# @deprecated Use productDiscontinuedNoteWidget instead of ProductDiscontinuedWidgetPlugin. #}
{% if isDiscontinued is not null %}
    {% set isDisabled = isDiscontinued or isDisabled %}
    {% set isProductAvailable = not isDiscontinued %}
{% endif %}

{% block body %}
    {% if brand is not empty %}
        <h5><small>{{'page.product.by' | trans}}</small> {{brand}}</h5>
    {% endif %}
    <small>{{ 'product.attribute.sku' | trans }}: {{sku}}</small>

    <hr />
    {% widget 'ProductPriceVolumeWidget' args [data.product] only %}
    {% elsewidget 'PriceProductVolumeWidgetPlugin' args [data.product] only %} {# @deprecated Use ProductPriceVolumeWidget instead. #}
    {% nowidget %}
        {% if widgetExists('PriceWidgetPlugin') %}
            {{ widget('PriceWidgetPlugin', data.product) }} {# @deprecated Use NEW_MOLECULE instead. #}
        {% else %}
            {# todo: include NEW_MOLECULE here #}
        {% endif %}
    {% endwidget %}

    {% widget 'ProductDetailPageReviewWidget' args [data.product.idProductAbstract] use view('pdp-review-rating', 'ProductReviewWidget') only %}
    {% nowidget %}
        {{ widgetBlock('ProductReviewWidgetPlugin', 'rating', data.product.idProductAbstract) }} {# @deprecated Use ProductDetailPageReviewWidget instead. #}
    {% endwidget %}
    {% widget 'ExampleProductColorSelectorWidget' args [data.product.idProductAbstract] use view('pdp-color-selector', 'ExampleProductColorGroupWidget') only %}
    {% elsewidget 'ProductGroupWidgetPlugin' args [data.product.idProductAbstract] only %} {# @deprecated Use ExampleProductColorSelectorWidget or ProductGroupWidget instead. #}
    {% endwidget %}

    {% embed molecule('variant-configurator', 'ProductDetailPage') with {
        data: {
            superAttributes: data.product.attributeMap.superAttributes,
            selectedAttributes: data.product.selectedAttributes,
            availableAttributes: data.product.availableAttributes
        }
    } only %}
        {% block body %}<hr />{{parent()}}{% endblock %}
    {% endembed %}

    <hr />
    <form method="POST" action="/cart/add/{{sku}}">
        {% widget 'ProductOptionConfiguratorWidget' args [data.product] only %}
        {% elsewidget 'ProductOptionWidgetPlugin' args [data.product] only %} {# @deprecated Use ProductOptionConfiguratorWidget instead. #}
        {% endwidget %}

        {% widget 'ProductPackagingUnitWidget' args [data.product, isDisabled, options] only %}
        {% elsewidget 'ProductPackagingUnitWidgetPlugin' args [data.product, isDisabled, options] only %} {# @deprecated Use ProductPackagingUnitWidget instead. #}
        {% elsewidget 'ManageProductMeasurementUnitWidget' args [data.product, isDisabled, options] only %}
        {% elsewidget 'ProductMeasurementUnitWidgetPlugin' args [data.product, isDisabled, options] only %} {# @deprecated Use ManageProductMeasurementUnitWidget instead. #}
        {% nowidget %}
            <div class="grid grid--bottom grid--justify">
                <div class="col col--sm-5">
                    <label>
                        {{'cart.item_quantity' | trans}}
                        {% include atom('select') with {
                            modifiers: ['expand'],
                            data: {
                                options: options
                            },
                            attributes: {
                                name: 'quantity',
                                disabled: isDisabled
                            }
                        } only %}
                    </label>
                </div>

                <div class="col col--sm-6">
                    <button type="submit" class="button button--success button--expand" {{ isDisabled ? 'disabled' : '' }} onclick="this.form.submit(); this.disabled='disabled'; return false;" {{qa('add-to-cart-button')}}>
                        {% include atom('icon') with {
                            data: {
                                name: 'cart-plus'
                            }
                        } only %}
                        {{ 'page.detail.add-to-cart' | trans }}
                    </button>
                </div>
            </div>
        {% endwidget %}

        {% widget 'AddToMultiCartWidget' args [data.product, isDisabled] only %}
        {% elsewidget 'MultiCartWidgetPlugin' args [data.product, isDisabled] only %} {# @deprecated Use AddToMultiCartWidget instead. #}
        {% endwidget %}

        {% if widgetExists('AvailabilityWidgetPlugin') %}
            {{ widget('AvailabilityWidgetPlugin', data.product) }}
        {% else %}
            {% include molecule('availability-product', 'AvailabilityWidget') ignore missing with {
                data: {
                    idProductConcrete: data.product.idProductConcrete,
                    isAvailable: data.product.available
                }
            } only %}
        {% endif %}
    </form>

    {% if isProductAvailable %}
        {% widget 'AddToShoppingListWidget' args [sku, isDisabled] only %}
            {% block body %}
                <hr />
                {{ parent() }}
            {% endblock %}
        {% elsewidget 'ShoppingListWidgetPlugin' args [sku, isDisabled] only %} {# @deprecated Use AddToShoppingListWidget instead. #}
            {% block body %}
                <hr />
                {{ parent() }}
            {% endblock %}
        {% endwidget %}
    {% endif %}

    {% if isProductAvailable %}
        {% if widgetExists('WishlistWidgetPlugin') %}
            <hr />
            {{ widget('WishlistWidgetPlugin', data.product) }} {# @deprecated Use NEW_MOLECULE instead. #}
        {% else %}
            <hr />
            {# todo: include NEW_MOLECULE here #}
        {% endif %}
    {% endif %}

    {% widget 'ProductDiscontinuedNoteWidget' args [sku] only %}
    {% elsewidget 'ProductDiscontinuedWidgetPlugin' args [sku] only %} {# @deprecated Use ProductDiscontinuedNoteWidget instead. #}
    {% endwidget %}

{% endblock %}
